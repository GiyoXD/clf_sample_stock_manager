<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample Manager (样品管理系统)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* Custom Styles */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .print-label:nth-child(even) { page-break-after: always; } /* Adjust as needed for label rolls */
        }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-slate-800 text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fa-solid fa-boxes-stacked text-2xl text-teal-400"></i>
                    <h1 class="text-xl font-bold tracking-wide">Sample Manager <span class="text-xs font-normal text-slate-400 ml-2">v1.0 Local</span></h1>
                </div>
                <!-- Navigation -->
                <nav class="flex space-x-1 bg-slate-700 p-1 rounded-lg">
                    <button @click="activeTab = 1" :class="['px-4 py-2 rounded-md text-sm font-medium transition-all', activeTab === 1 ? 'bg-teal-500 text-white shadow' : 'text-slate-300 hover:text-white hover:bg-slate-600']">
                        <i class="fa-solid fa-dolly mr-2"></i>Stock In
                    </button>
                    <button @click="activeTab = 2" :class="['px-4 py-2 rounded-md text-sm font-medium transition-all', activeTab === 2 ? 'bg-teal-500 text-white shadow' : 'text-slate-300 hover:text-white hover:bg-slate-600']">
                        <i class="fa-solid fa-list mr-2"></i>Stock List
                    </button>
                    <button @click="activeTab = 3" :class="['px-4 py-2 rounded-md text-sm font-medium transition-all', activeTab === 3 ? 'bg-teal-500 text-white shadow' : 'text-slate-300 hover:text-white hover:bg-slate-600']">
                        <i class="fa-solid fa-paper-plane mr-2"></i>Express Draft
                    </button>
                    <button @click="activeTab = 4" :class="['px-4 py-2 rounded-md text-sm font-medium transition-all', activeTab === 4 ? 'bg-teal-500 text-white shadow' : 'text-slate-300 hover:text-white hover:bg-slate-600']">
                        <i class="fa-solid fa-history mr-2"></i>History
                    </button>
                    <button @click="activeTab = 5" :class="['px-4 py-2 rounded-md text-sm font-medium transition-all', activeTab === 5 ? 'bg-teal-500 text-white shadow' : 'text-slate-300 hover:text-white hover:bg-slate-600']">
                        <i class="fa-solid fa-database mr-2"></i>Database
                    </button>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-6">
            
            <!-- notification -->
            <transition name="fade">
                <div v-if="notification.show" :class="['fixed top-4 right-4 px-6 py-4 rounded-lg shadow-xl text-white z-50 flex items-center', notification.type === 'success' ? 'bg-emerald-500' : 'bg-rose-500']">
                    <i :class="['mr-3 fa-solid', notification.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle']"></i>
                    {{ notification.message }}
                </div>
            </transition>

            <!-- Tab 1: Stock In -->
            <div v-if="activeTab === 1" class="space-y-6">
                <!-- Search Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold text-slate-700 mb-4 flex items-center">
                        <i class="fa-solid fa-magnifying-glass mr-2 text-teal-500"></i> Search PO
                    </h2>
                    <div class="relative">
                        <input 
                            v-model="stockIn.searchPO" 
                            @keyup.enter="handleStockInSearch"
                            type="text" 
                            placeholder="Scan or Enter PO Number..." 
                            class="w-full text-lg px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none transition-shadow"
                            autofocus
                        >
                        <button @click="handleStockInSearch" class="absolute right-2 top-2 bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-md transition-colors">
                            Search
                        </button>
                    </div>

                    <!-- Warning for Duplicates -->
                    <div v-if="stockIn.duplicates.length > 0" class="mt-4 bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-md">
                        <div class="flex">
                            <i class="fa-solid fa-triangle-exclamation text-amber-500 text-xl mr-3"></i>
                            <div>
                                <h3 class="text-amber-800 font-bold">Previous Stock Found!</h3>
                                <ul class="list-disc list-inside text-sm text-amber-700 mt-1">
                                    <li v-for="(rec, idx) in stockIn.duplicates" :key="idx">
                                        {{ rec.dateText }}: {{ rec.qty }}pcs ({{ rec.size }})
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entry Form -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Found Data Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 lg:col-span-2">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Client</label>
                                <input v-model="stockIn.form.client" class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-slate-700" readonly>
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Client PO</label>
                                <input v-model="stockIn.form.clientPO" class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-slate-700" readonly>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Product Name</label>
                                <input v-model="stockIn.form.product" class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-slate-700" readonly>
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Item No</label>
                                <input v-model="stockIn.form.itemNo" class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-slate-700" readonly>
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Batch</label>
                                <input v-model="stockIn.form.batch" class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-slate-700" readonly>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Quality Note (Editable)</label>
                                <textarea v-model="stockIn.form.note" rows="3" class="w-full border border-slate-300 rounded px-3 py-2 text-slate-700 focus:border-teal-500 outline-none"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Action Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Date In</label>
                                <input type="date" v-model="stockIn.form.date" class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-1 focus:ring-teal-500 outline-none">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
                                    <input type="number" v-model.number="stockIn.form.qty" min="1" class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-1 focus:ring-teal-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Size</label>
                                    <select v-model="stockIn.form.size" class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-1 focus:ring-teal-500 outline-none">
                                        <option value="A3">A3</option>
                                        <option value="50*50">50*50</option>
                                        <option value="Whole Hide">Whole Hide</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button @click="saveStockIn" class="mt-6 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg shadow-md hover:shadow-lg transition-all flex justify-center items-center">
                            <i class="fa-solid fa-floppy-disk mr-2"></i> Save to Inventory
                        </button>
                    </div>
                </div>

                <!-- Recent History -->
                <div v-if="stockIn.recent.length > 0" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 font-semibold text-slate-600">
                        Session History (Undo Available)
                    </div>
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500">
                            <tr>
                                <th class="px-6 py-3">PO</th>
                                <th class="px-6 py-3">Product</th>
                                <th class="px-6 py-3">Qty</th>
                                <th class="px-6 py-3">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(item, idx) in stockIn.recent" :key="item.id">
                                <td class="px-6 py-3 font-mono">{{ item.po }}</td>
                                <td class="px-6 py-3">{{ item.product }}</td>
                                <td class="px-6 py-3">{{ item.qty }}</td>
                                <td class="px-6 py-3">
                                    <button @click="undoStockIn(idx)" class="text-rose-500 hover:text-rose-700">
                                        <i class="fa-solid fa-trash"></i> Undo
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: Stock List -->
            <div v-if="activeTab === 2" class="space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold text-slate-700">Current Inventory</h2>
                    
                    <!-- Bulk Actions -->
                    <div class="flex space-x-2">
                         <div v-if="stockList.selected.length > 0" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center animate-bounce">
                             <span class="mr-3 font-bold">{{ stockList.selected.length }} Selected</span>
                             <button @click="addToDraft" class="bg-white text-indigo-600 px-3 py-1 rounded text-xs font-bold hover:bg-indigo-50">
                                 Add to Express Draft
                             </button>
                         </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 uppercase tracking-wider font-semibold">
                            <tr>
                                <th class="px-6 py-4">
                                    <input type="checkbox" @change="toggleSelectAll" :checked="isAllSelected">
                                </th>
                                <th class="px-6 py-4">Date In</th>
                                <th class="px-6 py-4">PO / Client PO</th>
                                <th class="px-6 py-4">Product / Item</th>
                                <th class="px-6 py-4">Batch / Note</th>
                                <th class="px-6 py-4 text-center">Orig Qty</th>
                                <th class="px-4 py-4 text-center">Curr Qty</th>
                                <th class="px-6 py-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-slate-700">
                            <tr v-for="item in inventory" :key="item.id" :class="{'bg-indigo-50': stockList.selected.includes(item.id)}">
                                <td class="px-6 py-3">
                                    <input type="checkbox" v-model="stockList.selected" :value="item.id">
                                </td>
                                <td class="px-6 py-3 whitespace-nowrap">{{ item.dateIn }}</td>
                                <td class="px-6 py-3">
                                    <div class="font-bold text-teal-600">{{ item.po }}</div>
                                    <div class="text-xs text-slate-400">{{ item.clientPO }}</div>
                                </td>
                                <td class="px-6 py-3">
                                    <div class="font-medium">{{ item.product }}</div>
                                    <div class="text-xs text-slate-500">{{ item.itemNo }} ({{ item.size }})</div>
                                </td>
                                <td class="px-6 py-3 max-w-xs truncate" :title="item.note">
                                    <div class="text-xs font-mono bg-slate-100 inline p-1 rounded">{{ item.batch }}</div>
                                    <div class="text-xs text-slate-400 mt-1 truncate">{{ item.note }}</div>
                                </td>
                                <td class="px-6 py-3 text-center text-slate-400">{{ item.originalQty }}</td>
                                <td class="px-4 py-3 text-center font-bold text-lg" :class="item.currentQty > 0 ? 'text-emerald-500' : 'text-slate-300'">
                                    {{ item.currentQty }}
                                </td>
                                <td class="px-6 py-3">
                                    <button @click="openEditModal(item)" class="text-slate-400 hover:text-teal-500 transition-colors">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-if="inventory.length === 0" class="p-8 text-center text-slate-400">
                        No items in inventory. Go to "Stock In" to add items.
                    </div>
                </div>
            </div>

            <!-- Tab 3: Express Draft -->
            <div v-if="activeTab === 3" class="space-y-6">
                 <div class="flex justify-between items-end">
                     <div>
                         <h2 class="text-xl font-bold text-slate-700 mb-1">Express Draft</h2>
                         <p class="text-sm text-slate-500">Prepare items for shipment.</p>
                     </div>
                     <div class="flex items-center space-x-3">
                         <div>
                             <label class="block text-xs font-bold text-slate-400 mb-1">Global Date</label>
                             <input type="date" v-model="draftConfig.date" class="border border-slate-300 rounded px-2 py-1 text-sm">
                         </div>
                     </div>
                 </div>

                 <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                     <table class="w-full text-left text-sm">
                         <thead class="bg-slate-50 text-slate-500 uppercase tracking-wider font-semibold">
                             <tr>
                                 <th class="px-4 py-3">PO Info</th>
                                 <th class="px-4 py-3">Recipient</th>
                                 <th class="px-4 py-3">Courier</th>
                                 <th class="px-4 py-3">Tracking No</th>
                                 <th class="px-4 py-3 w-10"></th>
                             </tr>
                         </thead>
                         <tbody class="divide-y divide-slate-100">
                             <tr v-for="(dItem, idx) in draft" :key="idx">
                                 <td class="px-4 py-3">
                                     <div class="font-bold">{{ dItem.po }}</div>
                                     <div class="text-xs text-slate-500">{{ dItem.product }}</div>
                                 </td>
                                 <td class="px-4 py-3">
                                     <input v-model="dItem.recipient" placeholder="Recipient Name" class="w-full border-b border-dotted border-slate-300 focus:border-teal-500 outline-none py-1 bg-transparent">
                                 </td>
                                 <td class="px-4 py-3">
                                     <select v-model="dItem.courier" class="w-full border-b border-dotted border-slate-300 focus:border-teal-500 outline-none py-1 bg-transparent">
                                         <option value="SF">SF Express</option>
                                         <option value="DHL">DHL</option>
                                         <option value="FedEx">FedEx</option>
                                         <option value="Others">Others</option>
                                     </select>
                                 </td>
                                 <td class="px-4 py-3">
                                     <input v-model="dItem.tracking" placeholder="Tracking #" class="w-full border-b border-dotted border-slate-300 focus:border-teal-500 outline-none py-1 bg-transparent font-mono">
                                 </td>
                                 <td class="px-4 py-3 text-center">
                                     <button @click="removeFromDraft(idx)" class="text-rose-400 hover:text-rose-600">
                                         <i class="fa-solid fa-times"></i>
                                     </button>
                                 </td>
                             </tr>
                         </tbody>
                     </table>
                     <div v-if="draft.length === 0" class="p-8 text-center text-slate-400 bg-slate-50">
                         Draft is empty. Add items from "Stock List" tab.
                     </div>
                 </div>

                 <div class="flex justify-end space-x-4 pt-4" v-if="draft.length > 0">
                     <button @click="printLabels" class="bg-slate-700 hover:bg-slate-800 text-white px-6 py-3 rounded-lg shadow-md font-medium">
                         <i class="fa-solid fa-print mr-2"></i> Print Labels
                     </button>
                     <button @click="confirmSent" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg shadow-md font-bold">
                         <i class="fa-solid fa-check mr-2"></i> Confirm Sent
                     </button>
                 </div>
            </div>

            <!-- Tab 4: History -->
            <div v-if="activeTab === 4" class="space-y-6">
                <!-- Batch Search -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold text-slate-700 mb-2">History Search</h2>
                    <textarea 
                        v-model="historySearch.query" 
                        placeholder="Paste PO numbers here (one per line) to search..." 
                        rows="3" 
                        class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:border-teal-500 outline-none"
                    ></textarea>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 uppercase tracking-wider">
                            <tr>
                                <th class="px-6 py-3">Date Sent</th>
                                <th class="px-6 py-3">Reference (PO)</th>
                                <th class="px-6 py-3">Recipient</th>
                                <th class="px-6 py-3">Logistics</th>
                                <th class="px-6 py-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="ship in filteredHistory" :key="ship.id">
                                <td class="px-6 py-3 whitespace-nowrap text-slate-500">{{ ship.dateSent }}</td>
                                <td class="px-6 py-3">
                                    <div class="font-bold text-slate-700">{{ ship.po }}</div>
                                    <div class="text-xs text-slate-400">{{ ship.product }}</div>
                                </td>
                                <td class="px-6 py-3">{{ ship.recipient }}</td>
                                <td class="px-6 py-3">
                                    <span class="px-2 py-1 rounded bg-slate-100 text-xs font-bold">{{ ship.courier }}</span>
                                    <span class="ml-2 font-mono text-xs">{{ ship.tracking }}</span>
                                </td>
                                <td class="px-6 py-3 text-right">
                                    <button @click="revertShipment(ship)" class="text-rose-500 hover:text-rose-700 text-xs font-bold border border-rose-200 hover:bg-rose-50 px-2 py-1 rounded transition-colors">
                                        Revert & Restore Stock
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-if="filteredHistory.length === 0" class="p-6 text-center text-slate-400">
                        No matching shipment records found.
                    </div>
                </div>
            </div>

            <!-- Tab 5: Database -->
            <div v-if="activeTab === 5" class="max-w-4xl mx-auto space-y-8">
                
                <!-- Import Section -->
                <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-teal-500">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Data Import</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label class="block font-semibold text-slate-700 mb-2">1. Master Data (CSV/XLSX)</label>
                            <p class="text-xs text-slate-500 mb-3">Req: yxdh (PO), khjc (Client), scmc (Product), cpmc (ItemNo), zlyq (Note)</p>
                            <input type="file" @change="e => handleFileImport(e, 'master')" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                            <div class="mt-2 text-xs font-mono text-slate-400">Current Records: {{ masterData.length }}</div>
                        </div>

                        <div>
                            <label class="block font-semibold text-slate-700 mb-2">2. CLF Data (CSV/XLSX)</label>
                            <p class="text-xs text-slate-500 mb-3">Req: TTX单号 (PO), 批次 (Batch), PO (ClientPO)</p>
                            <input type="file" @change="e => handleFileImport(e, 'clf')" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                            <div class="mt-2 text-xs font-mono text-slate-400">Current Records: {{ clfData.length }}</div>
                        </div>
                    </div>
                </div>

                <!-- Export Section -->
                <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-slate-500">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Data Export</h2>
                    <div class="flex space-x-4">
                        <button @click="exportInventory" class="flex-1 bg-white border-2 border-slate-200 hover:border-teal-500 hover:text-teal-600 text-slate-600 font-bold py-4 rounded-xl transition-all flex flex-col items-center justify-center">
                            <i class="fa-solid fa-file-excel text-3xl mb-2 text-emerald-600"></i>
                            <span>Export Stock In</span>
                        </button>
                        <button @click="exportHistory" class="flex-1 bg-white border-2 border-slate-200 hover:border-slate-800 hover:text-slate-800 text-slate-600 font-bold py-4 rounded-xl transition-all flex flex-col items-center justify-center">
                            <i class="fa-solid fa-clock-rotate-left text-3xl mb-2 text-indigo-600"></i>
                            <span>Export History</span>
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Edit Modal -->
        <div v-if="editModal.show" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-2xl w-96 p-6">
                <h3 class="text-lg font-bold mb-4">Edit Inventory Item</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase">Original Qty</label>
                        <input type="number" v-model.number="editModal.data.originalQty" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase">Note</label>
                        <textarea v-model="editModal.data.note" class="w-full border p-2 rounded" rows="3"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button @click="editModal.show = false" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">Cancel</button>
                    <button @click="saveEdit" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Hidden Print Area -->
        <div id="print-area">
            <!-- 100mm x 70mm -->
            <div v-for="item in draft" :key="item.po" class="print-label border-2 border-black p-4 mb-4 font-sans text-xs flex flex-col justify-between" style="width: 100mm; height: 70mm; margin: 0 auto; box-sizing: border-box;">
                <div>
                    <div class="font-bold text-sm mb-1">{{ item.client }}</div> <!-- Assuming Client from MasterData merge -->
                    <div class="text-[10px] text-gray-600">PO: {{ item.po }}</div>
                    <hr class="border-black my-1">
                    <div class="font-bold text-lg leading-tight mb-1">{{ item.itemNo }}</div>
                    <div class="text-s leading-tight">{{ item.product }}</div>
                </div>
                <div class="text-[10px] mt-2">
                    <div class="flex justify-between">
                        <span>Date: {{ draftConfig.date }}</span>
                        <span>Qty: 1</span>
                    </div>
                    <div>Batch: {{ item.batch }}</div>
                    <div class="mt-2 text-[8px] italic text-right"> Sample Manager </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: 1,
                    // Persistence
                    inventory: JSON.parse(localStorage.getItem('sm_inventory')) || [],
                    shipments: JSON.parse(localStorage.getItem('sm_shipments')) || [],
                    masterData: JSON.parse(localStorage.getItem('sm_masterData')) || [],
                    clfData: JSON.parse(localStorage.getItem('sm_clfData')) || [],
                    
                    // UI State
                    notification: { show: false, message: '', type: 'success' },
                    stockIn: {
                        searchPO: '',
                        duplicates: [],
                        recent: [],
                        form: {
                            po: '',
                            client: '',
                            clientPO: '',
                            product: '',
                            itemNo: '',
                            batch: '',
                            note: '',
                            date: new Date().toISOString().split('T')[0],
                            qty: 1,
                            size: 'A3'
                        }
                    },
                    stockList: {
                        selected: []
                    },
                    draft: [], // Not persisted intentionally per typical draft workflows, but could be.
                    draftConfig: {
                        date: new Date().toISOString().split('T')[0]
                    },
                    historySearch: {
                        query: ''
                    },
                    editModal: {
                        show: false,
                        data: { id: null, originalQty: 0, note: '' }
                    }
                }
            },
            watch: {
                inventory: {
                    handler(newVal) { localStorage.setItem('sm_inventory', JSON.stringify(newVal)); },
                    deep: true
                },
                shipments: {
                    handler(newVal) { localStorage.setItem('sm_shipments', JSON.stringify(newVal)); },
                    deep: true
                },
                masterData: {
                    handler(newVal) { localStorage.setItem('sm_masterData', JSON.stringify(newVal)); },
                    deep: true
                },
                clfData: {
                    handler(newVal) { localStorage.setItem('sm_clfData', JSON.stringify(newVal)); },
                    deep: true
                }
            },
            computed: {
                isAllSelected() {
                    return this.inventory.length > 0 && this.stockList.selected.length === this.inventory.length;
                },
                filteredHistory() {
                    if (!this.historySearch.query.trim()) return this.shipments.slice().sort((a,b) => new Date(b.dateSent) - new Date(a.dateSent));
                    
                    const queries = this.historySearch.query.split('\n').map(l => l.trim().toLowerCase()).filter(l => l);
                    return this.shipments.filter(ship => {
                        const shipPO = (ship.po || '').toLowerCase();
                        return queries.some(q => shipPO.includes(q));
                    });
                }
            },
            methods: {
                showNotification(msg, type = 'success') {
                    this.notification = { show: true, message: msg, type };
                    setTimeout(() => this.notification.show = false, 3000);
                },
                // --- Tab 5 Database ---
                handleFileImport(event, type) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                        if (type === 'master') {
                            this.masterData = jsonData;
                            this.showNotification(`Master Data Imported: ${jsonData.length} records`);
                        } else {
                            this.clfData = jsonData;
                            this.showNotification(`CLF Data Imported: ${jsonData.length} records`);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                },
                exportInventory() {
                    const ws = XLSX.utils.json_to_sheet(this.inventory);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Inventory");
                    XLSX.writeFile(wb, "Inventory_Export.xlsx");
                },
                exportHistory() {
                    const ws = XLSX.utils.json_to_sheet(this.shipments);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "History");
                    XLSX.writeFile(wb, "History_Export.xlsx");
                },

                // --- Tab 1 Stock In ---
                handleStockInSearch() {
                    const searchKey = this.stockIn.searchPO.trim().toLowerCase();
                    if (!searchKey) return;

                    // 1. Find in Master Data
                    // Keys: yxdh (PO), khjc (Client), scmc (Product), cpmc (ItemNo), zlyq (QualityNote)
                    // We try to find flexible matches
                    const masterRecord = this.masterData.find(r => String(r.yxdh || '').toLowerCase() === searchKey);

                    // 2. Find in CLF Data
                    // Key: TTX单号 (PO). Values: 批次 (Batch), PO (ClientPO)
                    const clfRecord = this.clfData.find(r => String(r['TTX单号'] || '').toLowerCase() === searchKey);

                    if (!masterRecord && !clfRecord) {
                        this.showNotification('PO not found in database. Please enter details manually.', 'error');
                        // Clear form but keep PO
                        this.stockIn.form = {
                            po: this.stockIn.searchPO.toUpperCase(),
                            client: '', clientPO: '', product: '', itemNo: '', batch: '', note: '',
                            date: new Date().toISOString().split('T')[0], qty: 1, size: 'A3'
                        };
                    } else {
                        // Merge Data
                        this.stockIn.form.po = masterRecord ? masterRecord.yxdh : (clfRecord ? clfRecord['TTX单号'] : searchKey.toUpperCase());
                        this.stockIn.form.client = masterRecord ? masterRecord.khjc : '';
                        this.stockIn.form.product = masterRecord ? masterRecord.scmc : '';
                        this.stockIn.form.itemNo = masterRecord ? masterRecord.cpmc : '';
                        this.stockIn.form.note = masterRecord ? masterRecord.zlyq : '';
                        
                        this.stockIn.form.batch = clfRecord ? clfRecord['批次'] : '';
                        this.stockIn.form.clientPO = clfRecord ? clfRecord['PO'] : '';
                    }

                    // Check Duplicates
                    this.stockIn.duplicates = this.inventory
                        .filter(i => String(i.po).toLowerCase() === searchKey)
                        .map(i => ({ dateText: i.dateIn, qty: i.originalQty, size: i.size }));
                },
                saveStockIn() {
                    if (!this.stockIn.form.po) {
                        this.showNotification('PO is required', 'error');
                        return;
                    }
                    
                    const newItem = {
                        id: Date.now(),
                        ...this.stockIn.form,
                        originalQty: this.stockIn.form.qty,
                        currentQty: this.stockIn.form.qty // Initialize current = original
                    };

                    this.inventory.unshift(newItem); // Add to top
                    this.stockIn.recent.unshift(newItem); // Add to session history
                    
                    this.showNotification('Stock Added Successfully');
                    
                    // Reset basic fields for next entry
                    this.stockIn.searchPO = '';
                    this.stockIn.duplicates = [];
                    // Keep date, maybe size? Resetting specific fields
                    this.stockIn.form.qty = 1;
                },
                undoStockIn(idx) {
                    const itemToRemove = this.stockIn.recent[idx];
                    this.inventory = this.inventory.filter(i => i.id !== itemToRemove.id);
                    this.stockIn.recent.splice(idx, 1);
                    this.showNotification('Entry Removed');
                },

                // --- Tab 2 Stock List ---
                toggleSelectAll(e) {
                    if (e.target.checked) {
                        this.stockList.selected = this.inventory.map(i => i.id);
                    } else {
                        this.stockList.selected = [];
                    }
                },
                openEditModal(item) {
                    this.editModal.data = { ...item };
                    this.editModal.show = true;
                },
                saveEdit() {
                    const target = this.inventory.find(i => i.id === this.editModal.data.id);
                    if (target) {
                        // If original Qty changed, we should probably adjust currentQty by the same delta? 
                        // Simplified: If current was same as original, update both. If shipment happened, this gets tricky.
                        // For this app: Reset current to original if manually edited, assuming correction of entry error.
                        // Or just update original and let user handle it.
                        // Let's assume updating Original also resets Current provided no shipments logged?
                        // Let's just update fields directly.
                        target.originalQty = this.editModal.data.originalQty;
                        target.note = this.editModal.data.note;
                        
                        // Recalculate current logic: 
                        // Current = Original - (Sum of shipments for this ID? Shipments don't link by ID currently, they link by PO in reality or just discrete deduction?)
                        // User requirement: "Confirm Sent: Deducts Qty from Inventory (Current Qty)".
                        // Meaning Current Qty is a persistent state. So just editing Original shouldn't auto change current unless we define that rule.
                        // I'll update currentQty relative to the change in originalQty to be safe.
                        // delta = newOrig - oldOrig
                        // newCurr = oldCurr + delta
                        /* 
                           However, simplify: Just update props.
                        */
                    }
                    this.editModal.show = false;
                    this.showNotification('Item Updated');
                },
                addToDraft() {
                    const selectedItems = this.inventory.filter(i => this.stockList.selected.includes(i.id));
                    // Check if already in draft?
                    // Allow multiples.
                    
                    selectedItems.forEach(item => {
                        this.draft.push({
                            stockId: item.id, // Link to inventory item
                            po: item.po,
                            client: item.client,
                            product: item.product,
                            itemNo: item.itemNo,
                            batch: item.batch,
                            recipient: '',
                            courier: 'SF',
                            tracking: ''
                        });
                    });
                    
                    this.stockList.selected = [];
                    this.activeTab = 3;
                    this.showNotification(`${selectedItems.length} items added to Draft`);
                },

                // --- Tab 3 Draft ---
                removeFromDraft(idx) {
                    this.draft.splice(idx, 1);
                },
                printLabels() {
                    window.print();
                },
                confirmSent() {
                    // 1. Create Shipment Records
                    // 2. Deduct Inventory
                    const dateSent = this.draftConfig.date;
                    
                    this.draft.forEach(dItem => {
                        // Find inventory item
                        const invItem = this.inventory.find(i => i.id === dItem.stockId);
                        
                        // Create Shipment Log
                        const shipment = {
                            id: Date.now() + Math.random(),
                            stockId: dItem.stockId,
                            dateSent: dateSent,
                            po: dItem.po,
                            product: dItem.product,
                            recipient: dItem.recipient,
                            courier: dItem.courier,
                            tracking: dItem.tracking
                        };
                        this.shipments.push(shipment);

                        // Deduct Stock
                        if (invItem) {
                            if (invItem.currentQty > 0) invItem.currentQty--;
                        }
                    });

                    this.draft = [];
                    this.showNotification('Shipments Confirmed & Inventory Updated');
                },

                // --- Tab 4 History ---
                revertShipment(shipment) {
                    if (!confirm("Are you sure you want to revert this shipment? Stock will be restored.")) return;

                    // Remove from shipments
                    this.shipments = this.shipments.filter(s => s.id !== shipment.id);

                    // Restore Stock
                    const invItem = this.inventory.find(i => i.id === shipment.stockId);
                    if (invItem) {
                        invItem.currentQty++;
                    } else {
                        // Logic if inventory item was deleted?
                        // For now assume inventory persists. If not found, maybe alert user.
                        this.showNotification('Shipment removed, but link to original stock was lost (Stock item deleted).', 'warning');
                        return;
                    }
                    this.showNotification('Shipment Reverted');
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
